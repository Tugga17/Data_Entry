Imports System.Windows.Forms

Public Class ProgressWindow
    Inherits Form

    Public WithEvents ProgressBar1 As New ProgressBar()
    Public WithEvents StatusLabel As New Label()

    Public Sub New(Optional title As String = "Uploading to Perfman")
        Me.Text = title
        Me.Width = 400
        Me.Height = 120
        Me.FormBorderStyle = FormBorderStyle.FixedDialog
        Me.StartPosition = FormStartPosition.CenterScreen
        Me.MaximizeBox = False
        Me.MinimizeBox = False

        ProgressBar1.Width = 350
        ProgressBar1.Height = 30
        ProgressBar1.Top = 20
        ProgressBar1.Left = 20
        ProgressBar1.Style = ProgressBarStyle.Continuous
        ProgressBar1.Minimum = 0
        ProgressBar1.Maximum = 100
        Me.Controls.Add(ProgressBar1)

        StatusLabel.Top = 60
        StatusLabel.Left = 20
        StatusLabel.Width = 350
        StatusLabel.Text = "Starting..."
        Me.Controls.Add(StatusLabel)
    End Sub

    Public Sub SetProgress(value As Integer, Optional statusText As String = "")
        If Me.InvokeRequired Then
            Me.Invoke(Sub() SetProgress(value, statusText))
        Else
            ProgressBar1.Value = Math.Min(ProgressBar1.Maximum, Math.Max(ProgressBar1.Minimum, value))
            If Not String.IsNullOrEmpty(statusText) Then
                StatusLabel.Text = statusText
            End If
        End If
    End Sub
End Class


Private Shared progressForm As ProgressWindow

progressForm = New ProgressWindow("Verifying Points")
progressForm.Show()
progressForm.Refresh()

If progressForm IsNot Nothing Then
    progressForm.Close()
    progressForm = Nothing
End If

Dim goodList As List(Of UPMPointsDTO)
progressForm = New ProgressWindow("Verifying Points")
progressForm.Show()
progressForm.Refresh()

goodList = VerifyPointsInDB(loadedList, badList)

If progressForm IsNot Nothing Then
    progressForm.Close()
    progressForm = Nothing
End If 



Private Function VerifyPointsInDB(ByVal list As List(Of UPMPointsDTO), ByRef badlist As List(Of UPMPointsDTO)) As List(Of UPMPointsDTO)
    Dim goodList As New List(Of UPMPointsDTO)
    Dim db As New PMPointsDB
    Dim total As Integer = list.Count
    Dim current As Integer = 0

    For Each item As UPMPointsDTO In list
        Dim dto = db.GetUPMPointFromExcel(item.MetricID, item.ReportingYear, item.PointsDescription, item.DataSeriesDescription)
        If IsNothing(dto) Then
            dto = New UPMPointsDTO With {
                .MetricID = item.MetricID,
                .ReportingYear = item.ReportingYear,
                .PointsDescription = item.PointsDescription,
                .YValue = item.YValue,
                .ChangedBy = item.DataSeriesDescription
            }
            LogDebug("VerifyPointsInDB failed â†’ MetricID: " & dto.MetricID)
            badlist.Add(dto)
        Else
            dto.YValue = item.YValue
            dto.ChangedBy = item.DataSeriesDescription
            goodList.Add(dto)
        End If

        current += 1
        If progressForm IsNot Nothing Then
            Dim percentComplete As Integer = CInt((current / total) * 100)
            progressForm.SetProgress(percentComplete, $"Verifying {current} of {total}")
            Application.DoEvents()
        End If
    Next

    Return goodList
End Function